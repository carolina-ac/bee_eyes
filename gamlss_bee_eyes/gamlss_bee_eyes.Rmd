---
title: "R Notebook"
output: md_document
---
# GAMLSS Analysis of Bee Eye Data

### Loading Libraries
```{r}
packages <- c('car', 'gamlss')
#lapply(packages, library, character.only = TRUE)
```

```{r, include=FALSE}
lapply(packages, library, character.only = TRUE)
```


### Loading and transform data

```{r}
# Load the data
eyes <- read.table("F:/open_git/bee_eyes/data/eyes_df.txt", header = TRUE, sep = "\t")

# Filter out specific species
eyes <- eyes[!(eyes$Species %in% c("Cyarrowi", "Coccidentalis")), ]

# Convert 'Species' to a factor
eyes$Species <- as.factor(eyes$Species)
eyes$Habit <- as.factor(eyes$Habit)

# Explicitly confirm the levels of Habit
eyes$Habit <- factor(eyes$Habit, levels = c("crepuscular", "diurnal"))
```


## Function Definitions
### Incremental Model Fitting
The function fit_incremental_models incrementally fits mixed models with random effects, starting with a base model and then adding fixed effects. An optional complex formula can be provided for a more advanced model.

```{r}
fit_incremental_models <- function(data, response, fixed_effects, random_effect = NULL, complex_formula = NULL) {
  models <- list()
  response_var <- as.formula(paste(response, "~ 1"))  # Base model with intercept only

  # 1. Base Model with Intercept Only
  # This model includes only the intercept, without any fixed or random effects.
  # Model: response ~ 1
  cat("Fitting base model with intercept only...\n")
  models[["m0"]] <- gamlss(response_var, data = data)

  # 2. Model with Random Intercept
  # If a random effect is specified, this model includes the intercept and the random effect.
  # Model: response ~ 1 + (1 | random_effect)
  if (!is.null(random_effect)) {
    random_formula <- as.formula(paste("~ 1 |", random_effect))
    cat("Fitting model with random intercept...\n")
    models[["m1"]] <- gamlss(response_var, random = random_formula, data = data)
  }

  # 3. Incremental Models with Fixed Effects and Random Intercept
  # For each specified fixed effect, a new model is created by adding the effect to the base model with a random intercept.
  for (i in seq_along(fixed_effects)) {
    effect <- fixed_effects[i]
    mu_formula <- update(response_var, paste("~ . +", effect))
    
    # Model: response ~ 1 + fixed_effect1 + ... + fixed_effecti + (1 | random_effect)
    cat("Fitting model with fixed effect:", effect, "...\n")
    models[[paste0("m", i + 2)]] <- gamlss(mu_formula, random = random_formula, data = data)
  }

  # 4. Final Model with Complex Formula
  # If a complex formula is provided, this model uses it with a random intercept.
  # Model: complex_formula + (1 | random_effect)
  if (!is.null(complex_formula)) {
    cat("Fitting complex model (m4)...\n")
    models[["m4"]] <- gamlss(as.formula(complex_formula), random = random_formula, data = data)
  }
  
  return(models)
}
```

# Model Summaries and AIC Comparison

These functions provide summaries of each model and compare models based on AIC values.
```{r}
# Function to print model summaries
print_model_summaries <- function(models) {
  cat("Model Summaries:\n")
  for (name in names(models)) {
    cat("Summary for model", name, ":\n")
    print(summary(models[[name]]))
    cat("\n")
  }
}

# Function to compare models based on AIC
compare_aics <- function(models) {
  aics <- sapply(models, AIC)
  aics_df <- data.frame(Model = names(aics), AIC = aics)
  print(aics_df)
  return(aics_df)
}

```

# Running the Incremental Modeling Process

Specify the target variable and fit incremental models, including a complex model with an interaction term.

```{r}
# Example usage
data <- eyes
response <- "vf"
fixed_effects <- c("di")  # Incremental fixed effects
random_effect <- "Species"
complex_formula <- "vf ~ di + Habit + di:Habit"  # Complex model formula for m4

models <- fit_incremental_models(data, response, fixed_effects, random_effect, complex_formula)
print_model_summaries(models)
compare_aics(models)

```

# Diagnostic and Visualization Functions
## Model Diagnostics
Functions to display diagnostic plots, model coefficients, and R-squared values for the final model.
```{r}
# Function to display diagnostic plots and R-squared
diagnostic_plots <- function(model) {
  qqPlot(residuals(model), ylab = "Residuals")
  cat("Model R-squared:", Rsq(model), "\n")
}

# Function to get final model coefficients
get_final_model_coefs <- function(model) {
  coefs <- coef(model)
  print(coefs)
  return(coefs)
}

# Apply diagnostic functions to the final model
final_model <- models[["m4"]]
get_final_model_coefs(final_model)
diagnostic_plots(final_model)

```
# Predicted vs Observed Plot by Habit

This function plots observed versus predicted values with separate lines for each level of Habit.

```{r}
library(ggplot2)

#Model with lowest AIC
m4 <- gamlss(vf ~ di + Habit + di:Habit, random = di | Species, data = eyes)

# Function to plot observed vs predicted values by group
plot_observed_vs_predicted <- function(model, data, x_var, y_var, group_var = "Habit") {
  # Remove rows with NA in relevant columns
  data <- data[complete.cases(data[, c(x_var, y_var, group_var)]), ]
  
  # Add predicted values to data
  data$predicted <- predict(model, newdata = data, type = "response")
  
  # Generate plot
  ggplot(data, aes_string(x = x_var, group = group_var)) +
    geom_point(aes_string(y = y_var, color = group_var), shape = 16) +  # Observed points
    geom_line(aes_string(y = "predicted", color = group_var), linewidth = 1) +  # Predicted lines
    theme_light() +
    labs(x = x_var, y = y_var, color = group_var) +
    scale_color_manual(values = c("crepuscular" = "purple", "diurnal" = "orange")) +
    theme(legend.title = element_blank())
}

# Example usage for plotting
plot_observed_vs_predicted(model = m4, data = eyes, x_var = "di", y_var = "vf", group_var ="Habit")

```
# Additional Plots

```{r}
# Plot term plot for final model
term.plot(m4)

```


